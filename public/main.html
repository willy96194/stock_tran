<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>æ¨¡æ“¬äº¤æ˜“å¹³å°</title>
    <!-- Bootstrap å¼•å…¥ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>

<body>
    <div class="mb-3 row d-flex justify-content-center">
        <label class="col-auto col-form-label">é¸æ“‡ä½¿ç”¨è€…ï¼š</label>
        <div class="col-md-4">
            <select class="form-select" id="userSelect">
                <option value="1">Willyï¼ˆuid: 1ï¼‰</option>
                <option value="2">éŸ­èœ (uid: 2)</option>
            </select>
        </div>
    </div>

    <div class="container mt-4">
        <!-- æ¥ä¸‹ä¾†æ¯å€‹å€å¡Šå¡«å…¥é€™è£¡ -->
        <div class="card shadow-sm p-4 rounded-0">
            <div class="d-flex justify-content-center mb-3">
                <h1 class="fs-3">ğŸ“Š æ¨¡æ“¬äº¤æ˜“å¹³å°é¦–é  </h1>
            </div>
        </div>
        <div class="card shadow-sm p-4 rounded-0">
            <form id="stockForm">
                <div class="mb-3 row d-flex justify-content-center">
                    <div class="col-auto d-flex align-items-center ">
                        <label for="stockCode" class="form-label">è‚¡ç¥¨ä»£ç¢¼æŸ¥è©¢:</label>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="stockInput" placeholder="è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button id="stockSearch" type="submit" class="btn btn-success border-0">æŸ¥è©¢</button>
                    </div>
                </div>
            </form>
            <div id="stockResult" class="text-center mt-3"></div>
        </div>


        <div class="card shadow-sm p-4 rounded-0">
            <div class="d-flex justify-content-center mb-3">
                <h2 class="fs-4 text-center mb-2">æ¨¡æ“¬ä¸‹å–®è¡¨å–®(è²·å…¥/è³£å‡º)</h2>
            </div>
            <div class="d-flex justify-content-end mb-3 " style="margin-right: 100px;">
                <h6>ç›®å‰æŒæœ‰è³‡é‡‘:<span id="userFunds"></span></h6>
            </div>
            <form id="stockOrderForm">
                <div class="mb-3 row d-flex justify-content-center">
                    <div class="col-auto d-flex align-items-center ">
                        <label for="stockPriceInput" class="form-label">å§”è¨—åƒ¹æ ¼:</label>
                    </div>
                    <div class="col-md-6">
                        <input type="number" class="form-control" id="stockPriceInput" placeholder="è«‹è¼¸å…¥æ¯è‚¡å§”è¨—åƒ¹æ ¼">
                    </div>
                </div>

                <div class="mb-3 row d-flex justify-content-center">
                    <div class="col-auto d-flex align-items-center ">
                        <label for="stockAmount" class="form-label">è‚¡æ•¸:</label>
                    </div>

                    <div class="col-md-6">
                        <input type="number" class="form-control" id="stockAmount" placeholder="è«‹è¼¸å…¥äº¤æ˜“è‚¡æ•¸">
                    </div>
                    <div class="col-auto">
                        <button id="stockBuy" type="submit" class="btn btn-success border-0">è²·å…¥</button>
                    </div>
                    <div class="col-auto">
                        <button id="stockSell" type="submit" class="btn btn-danger border-0">è³£å‡º</button>
                    </div>
                </div>


                <div class="mb-3 row d-flex justify-content-center">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>åˆª/æ”¹</th>
                                <th>åç¨±</th>
                                <th>å§”è¨—åƒ¹æ ¼</th>
                                <th>è‚¡æ•¸</th>
                                <th>äº¤æ˜“ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="stockOrderTableBody">

                        </tbody>
                    </table>
                </div>
            </form>
        </div>


        <div class="card shadow-sm p-4 rounded-0">
            <div class="d-flex justify-content-start ms-5 mb-3">
                <h2 class="fs-4 text-center mb-4"><i class="fas fa-folder-open">æˆ‘çš„æŒè‚¡</i></h2>
            </div>
            <form>
                <div class="mb-3 row d-flex justify-content-center">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                <th>åç¨±</th>
                                <th>è‚¡æ•¸</th>
                                <th>æˆæœ¬</th>
                                <th>ç¾åƒ¹</th>
                                <th>æç›Š</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">

                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>


    <script>
        let currentUid = 1; // é è¨­ç‚ºæ¸¬è©¦ç”¨æˆ¶ 1

        window.addEventListener("DOMContentLoaded", () => {
            fetchUserFunds(); // é è¨­è¼‰å…¥å¾Œå°±æŸ¥è³‡é‡‘
            fetchHoldings();
            fetchOrders();
        });

        document.getElementById("userSelect").addEventListener("change", async (e) => {
            currentUid = parseInt(e.target.value);
            await fetchUserFunds(); // æ¯æ¬¡åˆ‡æ›ä½¿ç”¨è€…æ™‚å°±æŸ¥è©¢è³‡é‡‘
            await fetchHoldings();
            await fetchOrders();
        });

        async function fetchUserFunds() {
            const res = await fetch(`/api/users/${currentUid}`);
            const data = await res.json();
            if (data?.funds != null) {
                setUserFunds(data.funds);
            } else {
                alert("æŸ¥ç„¡ä½¿ç”¨è€…è³‡è¨Š");
            }
        }

        //å–å¾—æŒè‚¡
        async function fetchHoldings() {
            const res = await fetch(`/api/users/${currentUid}/holdings`);
            const data = await res.json();

            const tbody = document.getElementById("stockTableBody");
            tbody.innerHTML = "";

            data.forEach(item => {
                const gainLoss = (item.currentPrice - item.cost) * item.stockAmount;
                const row = `
            <tr>
                <td>${item.stockid}</td>
                <td>${item.stockName}</td>
                <td>${item.stockAmount}</td>
                <td>${item.cost}</td>
                <td>${item.currentPrice}</td>
                <td>${gainLoss}</td>
            </tr>`;
                tbody.innerHTML += row;
            });
        }


        //å–å¾—å§”è¨—å–®
        async function fetchOrders() {
            const res = await fetch(`/api/users/${currentUid}/orders`);
            const data = await res.json();

            const tbody = document.getElementById("stockOrderTableBody");
            tbody.innerHTML = "";

            data.forEach(item => {
                const row = `
            <tr>
                <td>ï¼</td>
                <td>${item.stockName}</td>
                <td>${item.price}</td>
                <td>${item.amount}</td>
                <td>${item.status}</td>
            </tr>`;
                tbody.innerHTML += row;
            });
        }


        let currentStockPrice = null;
        let currentStockName = null;
        let currentStockCode = null;
        function setUserFunds(value) {
            document.getElementById("userFunds").innerText = Number(value).toLocaleString();
        }
        document.getElementById("stockForm").addEventListener("submit", async function (e) {
            e.preventDefault(); // é˜»æ­¢è¡¨å–®é€å‡º
            const input = document.getElementById("stockInput").value;

            const res = await fetch(`/api/stocks/search?query=${encodeURIComponent(input)}`);
            const data = await res.json();

            if (data && data.stockid) {
                document.getElementById("stockResult").innerHTML = `
                   <span>${data.stockName}(ä»£ç¢¼:${data.stockid}) ç¾åƒ¹:æ¯è‚¡${data.price}å…ƒ</span>`

                currentStockCode = data.stockid;
                currentStockName = data.stockName;
                currentStockPrice = parseInt(data.price);
            } else {
                document.getElementById("stockResult").innerHTML = `<p class="text-danger">æŸ¥ç„¡è©²è‚¡ç¥¨</p>`;
            }
        });
        document.getElementById("stockOrderForm").addEventListener("submit", handleSubmit);
        async function handleSubmit(e) {
            e.preventDefault();
            if (!currentStockPrice || !currentStockName) {
                alert("è«‹å…ˆæŸ¥è©¢è‚¡ç¥¨å†é€²è¡Œäº¤æ˜“");
                return;
            }
            const action = e.submitter.id;
            const stockAmount = parseInt(document.getElementById("stockAmount").value);
            const stockPriceInput = parseInt(document.getElementById("stockPriceInput").value);

            if (!stockAmount || stockAmount <= 0) {
                alert("è«‹è¼¸å…¥æ­£ç¢ºçš„è‚¡æ•¸");
                return;
            }
            const orderType = (action === "stockBuy") ? "buy" : "sell";


            const res = await fetch("/api/orders", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    uid: currentUid,
                    stockid: currentStockCode,
                    type: orderType,
                    price: stockPriceInput,
                    amount: stockAmount
                })
            });

            const data = await res.json();
            if (res.ok) {
                alert("æ›å–®æˆåŠŸ" + data.message);
                document.getElementById("stockAmount").value = "";
                await fetchUserFunds();
                await fetchHoldings();
                await fetchOrders();

                // å¯é¸ï¼šé‡æ–°åˆ·æ–°è¡¨æ ¼è³‡æ–™ï¼ˆå¾è³‡æ–™åº«æ’ˆä¸€æ¬¡ï¼‰
            } else {
                alert("âŒ æ›å–®å¤±æ•—ï¼š" + (data.message || "è«‹æŸ¥çœ‹ Console"));
                console.error(data);
            }
        }

    </script>
</body>

</html>